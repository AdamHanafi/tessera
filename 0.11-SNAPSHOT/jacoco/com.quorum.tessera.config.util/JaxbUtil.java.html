<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JaxbUtil.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">config</a> &gt; <a href="index.source.html" class="el_package">com.quorum.tessera.config.util</a> &gt; <span class="el_source">JaxbUtil.java</span></div><h1>JaxbUtil.java</h1><pre class="source lang-java linenums">package com.quorum.tessera.config.util;

import com.quorum.tessera.io.IOCallback;
import com.quorum.tessera.config.*;
import com.quorum.tessera.config.util.jaxb.MarshallerBuilder;
import com.quorum.tessera.config.util.jaxb.UnmarshallerBuilder;
import java.io.ByteArrayOutputStream;

import javax.xml.bind.JAXBException;
import javax.xml.bind.Marshaller;
import javax.xml.bind.Unmarshaller;
import javax.xml.transform.stream.StreamSource;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.StringReader;
import java.io.StringWriter;
import java.util.Objects;
import java.util.Optional;
import javax.validation.ConstraintViolationException;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.stream.StreamResult;

public final class JaxbUtil {

<span class="fc" id="L26">    public static final Class[] JAXB_CLASSES = new Class[]{</span>
        Config.class,
        KeyDataConfig.class,
        PrivateKeyData.class,
        ArgonOptions.class,
        JdbcConfig.class,
        KeyData.class,
        Peer.class,
        PrivateKeyType.class,
        ServerConfig.class,
        DeprecatedServerConfig.class,
        SslAuthenticationMode.class,
        SslConfig.class,
        SslTrustMode.class
    };

    private JaxbUtil() {
    }

    public static &lt;T&gt; T unmarshal(InputStream inputStream, Class&lt;T&gt; type) {

        try {
<span class="fc" id="L48">            return UnmarshallerBuilder.create()</span>
<span class="fc" id="L49">                    .build().unmarshal(new StreamSource(inputStream), type).getValue();</span>
<span class="fc" id="L50">        } catch (JAXBException ex) {</span>
<span class="fc" id="L51">            throw new ConfigException(ex);</span>
        }
    }

    public static void marshal(Object object, OutputStream outputStream) {
        try {
<span class="fc" id="L57">            MarshallerBuilder.create().build()</span>
<span class="fc" id="L58">                    .marshal(object, outputStream);</span>
<span class="fc" id="L59">        } catch (Throwable ex) {</span>
<span class="fc" id="L60">            Optional&lt;ConstraintViolationException&gt; validationException = unwrapConstraintViolationException(ex);</span>
<span class="fc bfc" id="L61" title="All 2 branches covered.">            if (validationException.isPresent()) {</span>
<span class="fc" id="L62">                throw validationException.get();</span>
            }
<span class="fc" id="L64">            throw new ConfigException(ex);</span>
<span class="fc" id="L65">        }</span>

<span class="fc" id="L67">    }</span>

    public static void marshalWithNoValidation(Object object, OutputStream outputStream) {
        try {
<span class="fc" id="L71">            MarshallerBuilder.create()</span>
<span class="fc" id="L72">                    .withoutBeanValidation()</span>
<span class="fc" id="L73">                    .build()</span>
<span class="fc" id="L74">                    .marshal(object, outputStream);</span>

<span class="fc" id="L76">        } catch (JAXBException ex) {</span>
<span class="fc" id="L77">            throw new ConfigException(ex);</span>
<span class="fc" id="L78">        }</span>
<span class="fc" id="L79">    }</span>

    public static String marshalToString(Object object) {
<span class="fc" id="L82">        return IOCallback.execute(() -&gt; {</span>
<span class="fc" id="L83">            try (OutputStream out = new ByteArrayOutputStream()) {</span>
<span class="fc" id="L84">                marshal(object, out);</span>
<span class="fc" id="L85">                return out.toString();</span>
            }
        });
    }

    public static String marshalToStringNoValidation(Object object) {
<span class="fc" id="L91">        return IOCallback.execute(() -&gt; {</span>
<span class="fc" id="L92">            try (OutputStream out = new ByteArrayOutputStream()) {</span>
<span class="fc" id="L93">                marshalWithNoValidation(object, out);</span>
<span class="fc" id="L94">                return out.toString();</span>
            }
        });
    }

    protected static Optional&lt;ConstraintViolationException&gt; unwrapConstraintViolationException(Throwable ex) {
<span class="fc" id="L100">        return Optional.of(ex)</span>
<span class="fc" id="L101">                .map(Throwable::getCause)</span>
<span class="fc" id="L102">                .filter(Objects::nonNull)</span>
<span class="fc" id="L103">                .filter(ConstraintViolationException.class::isInstance)</span>
<span class="fc" id="L104">                .map(ConstraintViolationException.class::cast);</span>
    }

    public static void marshalMasked(Config object, OutputStream outputStream) {

<span class="fc" id="L109">        XmlProcessingCallback.execute(() -&gt; {</span>

<span class="fc" id="L111">            Marshaller marshaller = MarshallerBuilder.create()</span>
<span class="fc" id="L112">                    .withXmlMediaType()</span>
<span class="fc" id="L113">                    .withoutBeanValidation()</span>
<span class="fc" id="L114">                    .build();</span>

            String xmlData;
<span class="fc" id="L117">            try (StringWriter writer = new StringWriter()) {</span>
<span class="fc" id="L118">                marshaller.marshal(object, writer);</span>
<span class="fc" id="L119">                xmlData = writer.toString();</span>
            }

<span class="fc" id="L122">            StreamSource xmlSource = new StreamSource(new StringReader(xmlData));</span>
<span class="fc" id="L123">            try (StringWriter writer = new StringWriter()) {</span>
<span class="fc" id="L124">                StreamResult xmlResult = new StreamResult(writer);</span>
<span class="fc" id="L125">                createMaskingXslTransformer().transform(xmlSource, xmlResult);</span>
<span class="fc" id="L126">                writer.flush();</span>

<span class="fc" id="L128">                Unmarshaller unmarshaller = UnmarshallerBuilder.create()</span>
<span class="fc" id="L129">                        .withXmlMediaType()</span>
<span class="fc" id="L130">                        .withoutBeanValidation()</span>
<span class="fc" id="L131">                        .build();</span>

<span class="fc" id="L133">                Config masked = (Config) unmarshaller.unmarshal(new StringReader(writer.toString()));</span>

<span class="fc" id="L135">                marshalWithNoValidation(masked, outputStream);</span>
<span class="fc" id="L136">                return null;</span>
            }

        });

<span class="fc" id="L141">    }</span>

    private static Transformer createMaskingXslTransformer() {
<span class="fc" id="L144">        return XmlProcessingCallback.execute(() -&gt; {</span>
<span class="fc" id="L145">            try (InputStream inputStream = JaxbUtil.class.getResourceAsStream(&quot;/xsl/mask-config.xsl&quot;)) {</span>
<span class="fc" id="L146">                return TransformerFactory.newInstance().newTransformer(new StreamSource(inputStream));</span>
            }
        });

    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>