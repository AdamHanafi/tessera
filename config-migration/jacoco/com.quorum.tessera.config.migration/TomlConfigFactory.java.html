<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TomlConfigFactory.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">config-migration</a> &gt; <a href="index.source.html" class="el_package">com.quorum.tessera.config.migration</a> &gt; <span class="el_source">TomlConfigFactory.java</span></div><h1>TomlConfigFactory.java</h1><pre class="source lang-java linenums">package com.quorum.tessera.config.migration;

import com.moandjiezana.toml.Toml;
import com.quorum.tessera.config.ArgonOptions;
import com.quorum.tessera.config.SslAuthenticationMode;
import com.quorum.tessera.config.builder.ConfigBuilder;
import com.quorum.tessera.config.builder.JdbcConfigFactory;
import com.quorum.tessera.config.builder.KeyDataBuilder;
import com.quorum.tessera.config.builder.SslTrustModeFactory;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.InputStream;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.List;
import java.util.Objects;
import java.util.Optional;

import static java.util.Collections.emptyList;

<span class="fc" id="L22">public class TomlConfigFactory {</span>

<span class="fc" id="L24">    private static final Logger LOGGER = LoggerFactory.getLogger(TomlConfigFactory.class);</span>

    public ConfigBuilder create(InputStream configData, ArgonOptions options, String... filenames) {
<span class="fc" id="L27">        Objects.requireNonNull(configData, &quot;No config data provided. &quot;);</span>
<span class="fc bfc" id="L28" title="All 2 branches covered.">        if (filenames.length != 0) {</span>
<span class="fc" id="L29">            throw new UnsupportedOperationException(&quot;keyConfigData arg is not implemented for TomlConfigFactory&quot;);</span>
        }

<span class="fc" id="L32">        Toml toml = new Toml().read(configData);</span>
<span class="fc" id="L33">        toml.toMap().forEach((key, value) -&gt; LOGGER.debug(&quot;Found entry in toml file : {} {}&quot;, key, value));</span>

<span class="fc" id="L35">        final String urlWithoutPort = Optional</span>
<span class="fc" id="L36">            .ofNullable(toml.getString(&quot;url&quot;))</span>
<span class="fc" id="L37">            .map(url -&gt; {</span>
                try {
<span class="fc" id="L39">                    return new URL(url);</span>
<span class="fc" id="L40">                } catch (final MalformedURLException e) {</span>
<span class="fc" id="L41">                    throw new RuntimeException(&quot;Bad server url given: &quot; + e.getMessage());</span>
                }
<span class="fc" id="L43">            }).map(uri -&gt; uri.getProtocol() + &quot;://&quot; + uri.getHost())</span>
<span class="fc" id="L44">            .orElse(null);</span>

<span class="fc" id="L46">        final Integer port = Optional.ofNullable(toml.getLong(&quot;port&quot;))</span>
<span class="fc" id="L47">            .map(Long::intValue)</span>
<span class="fc" id="L48">            .orElse(null);</span>

<span class="fc" id="L50">        final String workdir = toml.getString(&quot;workdir&quot;, &quot;&quot;);</span>
<span class="fc" id="L51">        final String socket = toml.getString(&quot;socket&quot;);</span>

<span class="fc" id="L53">        final String tls = toml.getString(&quot;tls&quot;, &quot;off&quot;).toUpperCase();</span>

<span class="fc" id="L55">        final List&lt;String&gt; othernodes = toml.getList(&quot;othernodes&quot;, emptyList());</span>

<span class="fc" id="L57">        final List&lt;String&gt; alwaysSendToKeyPaths = toml.getList(&quot;alwayssendto&quot;, emptyList());</span>

<span class="fc" id="L59">        final String storage = toml.getString(&quot;storage&quot;, &quot;memory&quot;);</span>

<span class="fc" id="L61">        final List&lt;String&gt; ipwhitelist = toml.getList(&quot;ipwhitelist&quot;, emptyList());</span>
<span class="fc bfc" id="L62" title="All 2 branches covered.">        final boolean useWhiteList = !ipwhitelist.isEmpty();</span>

        //Server side
<span class="fc" id="L65">        final String tlsservertrust = toml.getString(&quot;tlsservertrust&quot;, &quot;tofu&quot;);</span>
<span class="fc" id="L66">        final Optional&lt;String&gt; tlsserverkey = Optional.ofNullable(toml.getString(&quot;tlsserverkey&quot;));</span>
<span class="fc" id="L67">        final Optional&lt;String&gt; tlsservercert = Optional.ofNullable(toml.getString(&quot;tlsservercert&quot;));</span>
<span class="fc" id="L68">        final Optional&lt;List&lt;String&gt;&gt; tlsserverchainnames = Optional.ofNullable(toml.getList(&quot;tlsserverchain&quot;, emptyList()));</span>
<span class="fc" id="L69">        final Optional&lt;String&gt; tlsknownclients = Optional.ofNullable(toml.getString(&quot;tlsknownclients&quot;));</span>

        //Client side
<span class="fc" id="L72">        final String tlsclienttrust = toml.getString(&quot;tlsclienttrust&quot;, &quot;tofu&quot;);</span>
<span class="fc" id="L73">        final Optional&lt;String&gt; tlsclientkey = Optional.ofNullable(toml.getString(&quot;tlsclientkey&quot;));</span>
<span class="fc" id="L74">        final Optional&lt;String&gt; tlsclientcert = Optional.ofNullable(toml.getString(&quot;tlsclientcert&quot;));</span>
<span class="fc" id="L75">        final Optional&lt;List&lt;String&gt;&gt; tlsclientchainnames = Optional.ofNullable(toml.getList(&quot;tlsclientchain&quot;, emptyList()));</span>
<span class="fc" id="L76">        final Optional&lt;String&gt; tlsknownservers = Optional.ofNullable(toml.getString(&quot;tlsknownservers&quot;));</span>

<span class="fc" id="L78">        ConfigBuilder configBuilder = ConfigBuilder.create()</span>
<span class="fc" id="L79">            .serverPort(port)</span>
<span class="fc" id="L80">            .serverHostname(urlWithoutPort)</span>
<span class="fc" id="L81">            .unixSocketFile(socket)</span>
<span class="fc" id="L82">            .sslAuthenticationMode(SslAuthenticationMode.valueOf(tls))</span>
<span class="fc" id="L83">            .sslServerTrustMode(SslTrustModeFactory.resolveByLegacyValue(tlsservertrust))</span>
<span class="fc" id="L84">            .sslClientTrustMode(SslTrustModeFactory.resolveByLegacyValue(tlsclienttrust))</span>
<span class="fc" id="L85">            .peers(othernodes)</span>
<span class="fc" id="L86">            .alwaysSendTo(alwaysSendToKeyPaths)</span>
<span class="fc" id="L87">            .useWhiteList(useWhiteList)</span>
<span class="fc" id="L88">            .workdir(workdir);</span>

<span class="fc" id="L90">        tlsserverkey.ifPresent(configBuilder::sslServerTlsKeyPath);</span>
<span class="fc" id="L91">        tlsservercert.ifPresent(configBuilder::sslServerTlsCertificatePath);</span>
<span class="fc" id="L92">        tlsserverchainnames.ifPresent(configBuilder::sslServerTrustCertificates);</span>
<span class="fc" id="L93">        tlsknownclients.ifPresent(configBuilder::sslKnownClientsFile);</span>
<span class="fc" id="L94">        tlsclientkey.ifPresent(configBuilder::sslClientTlsKeyPath);</span>
<span class="fc" id="L95">        tlsclientcert.ifPresent(configBuilder::sslClientTlsCertificatePath);</span>
<span class="fc" id="L96">        tlsclientchainnames.ifPresent(configBuilder::sslClientTrustCertificates);</span>
<span class="fc" id="L97">        tlsknownservers.ifPresent(configBuilder::sslKnownServersFile);</span>

<span class="fc" id="L99">        Optional.ofNullable(storage)</span>
<span class="fc" id="L100">            .map(JdbcConfigFactory::fromLegacyStorageString)</span>
<span class="fc" id="L101">            .ifPresent(configBuilder::jdbcConfig);</span>

<span class="fc" id="L103">        return configBuilder;</span>
    }

    KeyDataBuilder createKeyDataBuilder(InputStream configData) {
<span class="fc" id="L107">        final Toml toml = new Toml().read(configData);</span>

<span class="fc" id="L109">        final List&lt;String&gt; publicKeyList = toml.getList(&quot;publickeys&quot;, emptyList());</span>

<span class="fc" id="L111">        final List&lt;String&gt; privateKeyList = toml.getList(&quot;privatekeys&quot;, emptyList());</span>

<span class="fc" id="L113">        final String pwd = toml.getString(&quot;passwords&quot;);</span>

<span class="fc" id="L115">        final String workdir = toml.getString(&quot;workdir&quot;);</span>

<span class="fc" id="L117">        return KeyDataBuilder.create()</span>
<span class="fc" id="L118">            .withPublicKeys(publicKeyList)</span>
<span class="fc" id="L119">            .withPrivateKeys(privateKeyList)</span>
<span class="fc" id="L120">            .withPrivateKeyPasswordFile(pwd)</span>
<span class="fc" id="L121">            .withWorkingDirectory(workdir);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>