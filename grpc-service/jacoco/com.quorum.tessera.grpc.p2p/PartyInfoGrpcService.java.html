<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PartyInfoGrpcService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">grpc-service</a> &gt; <a href="index.source.html" class="el_package">com.quorum.tessera.grpc.p2p</a> &gt; <span class="el_source">PartyInfoGrpcService.java</span></div><h1>PartyInfoGrpcService.java</h1><pre class="source lang-java linenums">package com.quorum.tessera.grpc.p2p;

import com.google.protobuf.ByteString;
import com.google.protobuf.Empty;
import com.google.protobuf.Timestamp;
import com.quorum.tessera.grpc.StreamObserverTemplate;
import com.quorum.tessera.node.PartyInfoParser;
import com.quorum.tessera.node.PartyInfoService;
import com.quorum.tessera.node.model.PartyInfo;
import com.quorum.tessera.node.model.Recipient;
import io.grpc.stub.StreamObserver;

import java.util.Map;
import java.util.Set;
import java.util.stream.Collectors;

import static java.util.Objects.requireNonNull;
import static java.util.stream.Collectors.toMap;

public class PartyInfoGrpcService extends PartyInfoGrpc.PartyInfoImplBase {

    private final PartyInfoParser partyInfoParser;

    private final PartyInfoService partyInfoService;

<span class="fc" id="L26">    public PartyInfoGrpcService(final PartyInfoService partyInfoService, final PartyInfoParser partyInfoParser) {</span>
<span class="fc" id="L27">        this.partyInfoService = requireNonNull(partyInfoService, &quot;partyInfoService must not be null&quot;);</span>
<span class="fc" id="L28">        this.partyInfoParser = requireNonNull(partyInfoParser, &quot;partyInfoParser must not be null&quot;);</span>
<span class="fc" id="L29">    }</span>

    @Override
    public void getPartyInfo(final PartyInfoMessage request, final StreamObserver&lt;PartyInfoMessage&gt; responseObserver) {

<span class="fc" id="L34">        final StreamObserverTemplate template = new StreamObserverTemplate(responseObserver);</span>

<span class="fc" id="L36">        template.handle(() -&gt; {</span>
            
<span class="fc" id="L38">            final PartyInfo partyInfo = partyInfoParser.from(request.getPartyInfo().toByteArray());</span>

<span class="fc" id="L40">            final PartyInfo updatedPartyInfo = partyInfoService.updatePartyInfo(partyInfo);</span>

<span class="fc" id="L42">            return PartyInfoMessage.newBuilder()</span>
<span class="fc" id="L43">                    .setPartyInfo(ByteString.copyFrom(partyInfoParser.to(updatedPartyInfo)))</span>
<span class="fc" id="L44">                    .build();</span>

        });
<span class="fc" id="L47">    }</span>

    @Override
    public void getPartyInfoMessage(final Empty request, final StreamObserver&lt;PartyInfoJson&gt; responseObserver) {

<span class="fc" id="L52">        final StreamObserverTemplate template = new StreamObserverTemplate(responseObserver);</span>

<span class="fc" id="L54">        template.handle(() -&gt; {</span>

<span class="fc" id="L56">            final PartyInfo partyInfo = partyInfoService.getPartyInfo();</span>
<span class="fc" id="L57">            final Set&lt;Peer&gt; peers = partyInfo.getParties()</span>
<span class="fc" id="L58">                .stream()</span>
<span class="fc" id="L59">                .filter(p -&gt; p.getUrl().endsWith(&quot;/&quot;))</span>
<span class="fc" id="L60">                .map(party -&gt; {</span>
<span class="fc" id="L61">                    final Peer.Builder builder = Peer.newBuilder().setUrl(party.getUrl());</span>

<span class="fc bfc" id="L63" title="All 2 branches covered.">                    if (party.getLastContacted() != null) {</span>
<span class="fc" id="L64">                        final Timestamp timestamp = Timestamp.newBuilder()</span>
<span class="fc" id="L65">                            .setSeconds(party.getLastContacted().getEpochSecond())</span>
<span class="fc" id="L66">                            .build();</span>

<span class="fc" id="L68">                        builder.setUtcTimestamp(timestamp);</span>
                    }

<span class="fc" id="L71">                    return builder.build();</span>
<span class="fc" id="L72">                }).collect(Collectors.toSet());</span>

<span class="fc" id="L74">            final Map&lt;String, String&gt; keys = partyInfo.getRecipients()</span>
<span class="fc" id="L75">                .stream()</span>
<span class="fc" id="L76">                .collect(toMap(r -&gt; r.getKey().encodeToBase64(), Recipient::getUrl));</span>

<span class="fc" id="L78">            return PartyInfoJson.newBuilder()</span>
<span class="fc" id="L79">                .setUrl(partyInfo.getUrl())</span>
<span class="fc" id="L80">                .addAllPeers(peers)</span>
<span class="fc" id="L81">                .putAllKeys(keys)</span>
<span class="fc" id="L82">                .build();</span>

        });
<span class="fc" id="L85">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>