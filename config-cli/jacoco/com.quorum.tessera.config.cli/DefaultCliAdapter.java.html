<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DefaultCliAdapter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">config-cli</a> &gt; <a href="index.source.html" class="el_package">com.quorum.tessera.config.cli</a> &gt; <span class="el_source">DefaultCliAdapter.java</span></div><h1>DefaultCliAdapter.java</h1><pre class="source lang-java linenums">package com.quorum.tessera.config.cli;

import com.quorum.tessera.config.Config;
import com.quorum.tessera.config.cli.parsers.ConfigurationParser;
import com.quorum.tessera.config.cli.parsers.KeyGenerationParser;
import com.quorum.tessera.config.cli.parsers.KeyUpdateParser;
import com.quorum.tessera.config.cli.parsers.PidFileParser;
import com.quorum.tessera.config.keypairs.ConfigKeyPair;
import com.quorum.tessera.config.keys.KeyEncryptorFactory;
import com.quorum.tessera.config.util.PasswordReaderFactory;
import org.apache.commons.cli.*;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.validation.ConstraintViolation;
import javax.validation.ConstraintViolationException;
import javax.validation.Validation;
import javax.validation.Validator;
import java.io.IOException;
import java.io.PrintWriter;
import java.util.*;

<span class="fc" id="L23">public class DefaultCliAdapter implements CliAdapter {</span>

<span class="fc" id="L25">    private static final Logger LOGGER = LoggerFactory.getLogger(DefaultCliAdapter.class);</span>

<span class="fc" id="L27">    private final Validator validator = Validation.byDefaultProvider()</span>
<span class="fc" id="L28">        .configure()</span>
<span class="fc" id="L29">        .ignoreXmlConfiguration()</span>
<span class="fc" id="L30">        .buildValidatorFactory()</span>
<span class="fc" id="L31">        .getValidator();</span>

    @Override
    public CliResult execute(String... args) throws Exception {

<span class="fc" id="L36">        Options options = this.buildBaseOptions();</span>

<span class="fc" id="L38">        Map&lt;String, Class&gt; overrideOptions = OverrideUtil.buildConfigOptions();</span>

<span class="fc" id="L40">        overrideOptions.forEach((optionName, optionType) -&gt; {</span>

<span class="fc" id="L42">            final boolean isCollection = optionType.isArray();</span>

<span class="fc" id="L44">            Option.Builder optionBuilder = Option.builder()</span>
<span class="fc" id="L45">                .longOpt(optionName)</span>
<span class="fc" id="L46">                .desc(String.format(&quot;Override option for %s , type: %s&quot;, optionName, optionType.getSimpleName()));</span>

<span class="fc bfc" id="L48" title="All 2 branches covered.">            if (isCollection) {</span>
<span class="fc" id="L49">                optionBuilder.hasArgs().argName(optionType.getSimpleName().toUpperCase() + &quot;...&quot;);</span>
            } else {
<span class="fc" id="L51">                optionBuilder.hasArg().argName(optionType.getSimpleName().toUpperCase());</span>
            }

<span class="fc" id="L54">            options.addOption(optionBuilder.build());</span>

<span class="fc" id="L56">        });</span>

<span class="fc" id="L58">        final List&lt;String&gt; argsList = Arrays.asList(args);</span>
<span class="fc bfc" id="L59" title="All 4 branches covered.">        if (argsList.contains(&quot;help&quot;) || argsList.isEmpty()) {</span>
<span class="fc" id="L60">            HelpFormatter formatter = new HelpFormatter();</span>
<span class="fc" id="L61">            PrintWriter pw = new PrintWriter(sys().out());</span>
<span class="fc" id="L62">            formatter.printHelp(pw, </span>
                    200, &quot;tessera -configfile &lt;PATH&gt; [-keygen &lt;PATH&gt;] [-pidfile &lt;PATH&gt;]&quot;, 
<span class="fc" id="L64">                    null, options, formatter.getLeftPadding(), </span>
<span class="fc" id="L65">                    formatter.getDescPadding(), null, false);</span>
<span class="fc" id="L66">            pw.flush();</span>
<span class="fc" id="L67">            return new CliResult(0, true, null);</span>
        }

        try {

<span class="fc" id="L72">            final CommandLine line = new DefaultParser().parse(options, args);</span>

<span class="fc" id="L74">            final Config config = parseConfig(line);</span>

<span class="fc bfc" id="L76" title="All 2 branches covered.">            if (Objects.nonNull(config)) {</span>

<span class="fc" id="L78">                overrideOptions.forEach((optionName, value) -&gt; {</span>
<span class="fc bfc" id="L79" title="All 2 branches covered.">                    if (line.hasOption(optionName)) {</span>
<span class="fc" id="L80">                        String[] values = line.getOptionValues(optionName);</span>
<span class="fc" id="L81">                        LOGGER.debug(&quot;Setting : {} with value(s) {}&quot;, optionName, values);</span>
<span class="fc" id="L82">                        OverrideUtil.setValue(config, optionName, values);</span>
<span class="fc" id="L83">                        LOGGER.debug(&quot;Set : {} with value(s) {}&quot;, optionName, values);</span>
                    }
<span class="fc" id="L85">                });</span>

<span class="fc" id="L87">                Set&lt;ConstraintViolation&lt;Config&gt;&gt; violations = validator.validate(config);</span>
<span class="fc bfc" id="L88" title="All 2 branches covered.">                if (!violations.isEmpty()) {</span>
<span class="fc" id="L89">                    throw new ConstraintViolationException(violations);</span>
                }
            }

<span class="fc" id="L93">            new PidFileParser().parse(line);</span>

<span class="fc bfc" id="L95" title="All 4 branches covered.">            boolean suppressStartup = line.hasOption(&quot;keygen&quot;) &amp;&amp; Objects.isNull(config);</span>

<span class="fc" id="L97">            return new CliResult(0, suppressStartup, config);</span>

<span class="fc" id="L99">        } catch (ParseException exp) {</span>
<span class="fc" id="L100">            throw new CliException(exp.getMessage());</span>
        }

    }

    private Config parseConfig(CommandLine commandLine) throws IOException {

<span class="fc bfc" id="L107" title="All 2 branches covered.">        if(commandLine.hasOption(&quot;updatepassword&quot;)) {</span>
<span class="fc" id="L108">            new KeyUpdateParser(</span>
<span class="fc" id="L109">                KeyEncryptorFactory.create(),</span>
<span class="fc" id="L110">                PasswordReaderFactory.create()</span>
<span class="fc" id="L111">            ).parse(commandLine);</span>

            //return early so other options don't get processed
<span class="fc" id="L114">            return null;</span>
        }

<span class="fc" id="L117">        final List&lt;ConfigKeyPair&gt; newKeys = new KeyGenerationParser().parse(commandLine);</span>

<span class="fc" id="L119">        final Config config = new ConfigurationParser().withNewKeys(newKeys).parse(commandLine);</span>

<span class="pc bpc" id="L121" title="1 of 6 branches missed.">        if (!commandLine.hasOption(&quot;configfile&quot;) &amp;&amp; !commandLine.hasOption(&quot;keygen&quot;) &amp;&amp; !commandLine.hasOption(&quot;updatepassword&quot;)) {</span>
<span class="fc" id="L122">            throw new CliException(&quot;One or more: -configfile or -keygen or -updatepassword options are required.&quot;);</span>
        }

<span class="fc" id="L125">        return config;</span>
    }

    private Options buildBaseOptions() {

<span class="fc" id="L130">        final Options options = new Options();</span>

<span class="fc" id="L132">        options.addOption(</span>
<span class="fc" id="L133">            Option.builder(&quot;configfile&quot;)</span>
<span class="fc" id="L134">                .desc(&quot;Path to node configuration file&quot;)</span>
<span class="fc" id="L135">                .hasArg(true)</span>
<span class="fc" id="L136">                .optionalArg(false)</span>
<span class="fc" id="L137">                .numberOfArgs(1)</span>
<span class="fc" id="L138">                .argName(&quot;PATH&quot;)</span>
<span class="fc" id="L139">                .build());</span>

<span class="fc" id="L141">        options.addOption(</span>
<span class="fc" id="L142">            Option.builder(&quot;keygen&quot;)</span>
<span class="fc" id="L143">                .desc(&quot;Use this option to generate public/private keypair&quot;)</span>
<span class="fc" id="L144">                .hasArg(false)</span>
<span class="fc" id="L145">                .build());</span>

<span class="fc" id="L147">        options.addOption(</span>
<span class="fc" id="L148">            Option.builder(&quot;filename&quot;)</span>
<span class="fc" id="L149">                .desc(&quot;Comma-separated list of paths to save generated key files. Can also be used with keyvault. Number of args equals number of key-pairs generated.&quot;)</span>
<span class="fc" id="L150">                .hasArgs()</span>
<span class="fc" id="L151">                .optionalArg(false)</span>
<span class="fc" id="L152">                .argName(&quot;PATH&quot;)</span>
<span class="fc" id="L153">                .build());</span>

<span class="fc" id="L155">        options.addOption(</span>
<span class="fc" id="L156">            Option.builder(&quot;keygenconfig&quot;)</span>
<span class="fc" id="L157">                .desc(&quot;Path to private key config for generation of missing key files&quot;)</span>
<span class="fc" id="L158">                .hasArg(true)</span>
<span class="fc" id="L159">                .optionalArg(false)</span>
<span class="fc" id="L160">                .argName(&quot;PATH&quot;)</span>
<span class="fc" id="L161">                .build());</span>

<span class="fc" id="L163">        options.addOption(</span>
<span class="fc" id="L164">            Option.builder(&quot;output&quot;)</span>
<span class="fc" id="L165">                .desc(&quot;Generate updated config file with generated keys&quot;)</span>
<span class="fc" id="L166">                .hasArg(true)</span>
<span class="fc" id="L167">                .numberOfArgs(1)</span>
<span class="fc" id="L168">                .build());</span>

<span class="fc" id="L170">        options.addOption(</span>
<span class="fc" id="L171">            Option.builder(&quot;keygenvaulttype&quot;)</span>
<span class="fc" id="L172">                .desc(&quot;Type of key vault the generated key is to be saved in&quot;)</span>
<span class="fc" id="L173">                .hasArg()</span>
<span class="fc" id="L174">                .optionalArg(false)</span>
<span class="fc" id="L175">                .argName(&quot;KEYVAULTTYPE&quot;)</span>
<span class="fc" id="L176">                .build()</span>
        );

<span class="fc" id="L179">        options.addOption(</span>
<span class="fc" id="L180">            Option.builder(&quot;keygenvaulturl&quot;)</span>
<span class="fc" id="L181">                .desc(&quot;Base url for key vault&quot;)</span>
<span class="fc" id="L182">                .hasArg()</span>
<span class="fc" id="L183">                .optionalArg(false)</span>
<span class="fc" id="L184">                .argName(&quot;STRING&quot;)</span>
<span class="fc" id="L185">                .build()</span>
        );

<span class="fc" id="L188">        options.addOption(</span>
<span class="fc" id="L189">            Option.builder(&quot;keygenvaultapprole&quot;)</span>
<span class="fc" id="L190">                  .desc(&quot;AppRole path for Hashicorp Vault authentication (defaults to 'approle')&quot;)</span>
<span class="fc" id="L191">                  .hasArg()</span>
<span class="fc" id="L192">                  .optionalArg(false)</span>
<span class="fc" id="L193">                  .argName(&quot;STRING&quot;)</span>
<span class="fc" id="L194">                  .build()</span>
        );

<span class="fc" id="L197">        options.addOption(</span>
<span class="fc" id="L198">            Option.builder(&quot;keygenvaultkeystore&quot;)</span>
<span class="fc" id="L199">                .desc(&quot;Path to JKS keystore for TLS Hashicorp Vault communication&quot;)</span>
<span class="fc" id="L200">                .hasArg()</span>
<span class="fc" id="L201">                .optionalArg(false)</span>
<span class="fc" id="L202">                .argName(&quot;PATH&quot;)</span>
<span class="fc" id="L203">                .build()</span>
        );

<span class="fc" id="L206">        options.addOption(</span>
<span class="fc" id="L207">            Option.builder(&quot;keygenvaulttruststore&quot;)</span>
<span class="fc" id="L208">                  .desc(&quot;Path to JKS truststore for TLS Hashicorp Vault communication&quot;)</span>
<span class="fc" id="L209">                  .hasArg()</span>
<span class="fc" id="L210">                  .optionalArg(false)</span>
<span class="fc" id="L211">                  .argName(&quot;PATH&quot;)</span>
<span class="fc" id="L212">                  .build()</span>
        );

<span class="fc" id="L215">        options.addOption(</span>
<span class="fc" id="L216">            Option.builder(&quot;keygenvaultsecretengine&quot;)</span>
<span class="fc" id="L217">                  .desc(&quot;Name of already enabled Hashicorp v2 kv secret engine&quot;)</span>
<span class="fc" id="L218">                  .hasArg()</span>
<span class="fc" id="L219">                  .optionalArg(false)</span>
<span class="fc" id="L220">                  .argName(&quot;STRING&quot;)</span>
<span class="fc" id="L221">                  .build()</span>
        );

<span class="fc" id="L224">        options.addOption(</span>
<span class="fc" id="L225">            Option.builder(&quot;pidfile&quot;)</span>
<span class="fc" id="L226">                .desc(&quot;Path to pid file&quot;)</span>
<span class="fc" id="L227">                .hasArg(true)</span>
<span class="fc" id="L228">                .optionalArg(false)</span>
<span class="fc" id="L229">                .numberOfArgs(1)</span>
<span class="fc" id="L230">                .argName(&quot;PATH&quot;)</span>
<span class="fc" id="L231">                .build());</span>

<span class="fc" id="L233">        options.addOption(</span>
<span class="fc" id="L234">            Option.builder(&quot;updatepassword&quot;)</span>
<span class="fc" id="L235">                .desc(&quot;Update the password for a locked key&quot;)</span>
<span class="fc" id="L236">                .hasArg(false)</span>
<span class="fc" id="L237">                .build()</span>
        );

<span class="fc" id="L240">        return options;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>