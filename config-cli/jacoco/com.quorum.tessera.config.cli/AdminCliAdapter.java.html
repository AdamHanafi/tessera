<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AdminCliAdapter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">config-cli</a> &gt; <a href="index.source.html" class="el_package">com.quorum.tessera.config.cli</a> &gt; <span class="el_source">AdminCliAdapter.java</span></div><h1>AdminCliAdapter.java</h1><pre class="source lang-java linenums">package com.quorum.tessera.config.cli;

import com.quorum.tessera.config.*;
import com.quorum.tessera.config.cli.parsers.ConfigurationParser;
import com.quorum.tessera.jaxrs.client.ClientFactory;
import java.io.PrintWriter;
import java.net.URI;
import java.util.Arrays;
import java.util.List;
import java.util.Objects;
import java.util.Optional;
import javax.ws.rs.client.Client;
import javax.ws.rs.client.Entity;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import javax.ws.rs.core.UriBuilder;
import org.apache.commons.cli.CommandLine;
import org.apache.commons.cli.DefaultParser;
import org.apache.commons.cli.HelpFormatter;
import org.apache.commons.cli.Option;
import org.apache.commons.cli.Options;

/**
 * Cli Adapter to be used for runtime updates
 */
public class AdminCliAdapter implements CliAdapter {

    private final ClientFactory clientFactory;

<span class="fc" id="L30">    public AdminCliAdapter(final ClientFactory clientFactory) {</span>
<span class="fc" id="L31">        this.clientFactory = Objects.requireNonNull(clientFactory);</span>
<span class="fc" id="L32">    }</span>

    /**
     *
     * @param args
     * @return CliResult with config object always null.
     * @throws Exception
     */
    @Override
    public CliResult execute(String... args) throws Exception {

<span class="fc" id="L43">        final Options options = new Options();</span>

<span class="fc" id="L45">        options.addOption(</span>
<span class="fc" id="L46">                Option.builder(&quot;configfile&quot;)</span>
<span class="fc" id="L47">                        .desc(&quot;Path to node configuration file&quot;)</span>
<span class="fc" id="L48">                        .hasArg(true)</span>
<span class="fc" id="L49">                        .required()</span>
<span class="fc" id="L50">                        .optionalArg(false)</span>
<span class="fc" id="L51">                        .numberOfArgs(1)</span>
<span class="fc" id="L52">                        .argName(&quot;PATH&quot;)</span>
<span class="fc" id="L53">                        .build());</span>

<span class="fc" id="L55">        options.addOption(Option.builder(&quot;addpeer&quot;)</span>
<span class="fc" id="L56">                .desc(&quot;Add peer to running node&quot;)</span>
<span class="fc" id="L57">                .hasArg(true)</span>
<span class="fc" id="L58">                .optionalArg(false)</span>
<span class="fc" id="L59">                .numberOfArgs(1)</span>
<span class="fc" id="L60">                .argName(&quot;URL&quot;)</span>
<span class="fc" id="L61">                .build());</span>

<span class="fc" id="L63">        final List&lt;String&gt; argsList = Arrays.asList(args);</span>

<span class="pc bpc" id="L65" title="1 of 4 branches missed.">        if (argsList.contains(&quot;help&quot;) || argsList.isEmpty()) {</span>
<span class="fc" id="L66">            HelpFormatter formatter = new HelpFormatter();</span>
<span class="fc" id="L67">            PrintWriter pw = new PrintWriter(sys().out());</span>
<span class="fc" id="L68">            formatter.printHelp(pw,</span>
                    200, &quot;tessera admin&quot;,
<span class="fc" id="L70">                    null, options, formatter.getLeftPadding(),</span>
<span class="fc" id="L71">                    formatter.getDescPadding(), null, false);</span>
<span class="fc" id="L72">            pw.flush();</span>
            
<span class="fc" id="L74">            return new CliResult(0, true, null);</span>
        }

<span class="fc" id="L77">        final CommandLine line = new DefaultParser().parse(options, args);</span>
<span class="fc bfc" id="L78" title="All 2 branches covered.">        if (!line.hasOption(&quot;addpeer&quot;)) {</span>
<span class="fc" id="L79">            sys().out().println(&quot;No peer defined&quot;);</span>
<span class="fc" id="L80">            return new CliResult(1, true, null);</span>
        }

<span class="fc" id="L83">        Config config = new ConfigurationParser().parse(line);</span>

        //TODO revisit - maybe the admin stuff should be reached via unix socket - in order to avoid security concerns
<span class="fc" id="L86">        ServerConfig serverConfig = config.getServerConfigs().stream()</span>
<span class="fc bfc" id="L87" title="All 2 branches covered.">                .filter(c -&gt; c.getApp() == AppType.ADMIN)</span>
<span class="fc" id="L88">                .findFirst().orElse(config.getServerConfigs().stream().findAny().get());</span>

<span class="fc" id="L90">        Client restClient = clientFactory.buildFrom(serverConfig);</span>

<span class="fc" id="L92">        String peerUrl = line.getOptionValue(&quot;addpeer&quot;);</span>

<span class="fc" id="L94">        final Peer peer = new Peer(peerUrl);</span>

<span class="fc" id="L96">        String scheme = Optional.of(serverConfig)</span>
<span class="fc" id="L97">                .map(ServerConfig::getBindingUri)</span>
<span class="fc" id="L98">                .map(URI::getScheme)</span>
<span class="fc" id="L99">                .orElse(&quot;http&quot;);</span>

<span class="fc" id="L101">        Integer port = Optional.of(serverConfig)</span>
<span class="fc" id="L102">                .map(ServerConfig::getServerUri)</span>
<span class="fc" id="L103">                .map(URI::getPort)</span>
<span class="fc" id="L104">                .orElse(80);</span>

<span class="fc" id="L106">        URI uri = UriBuilder.fromUri(serverConfig.getBindingUri())</span>
<span class="fc" id="L107">                .port(port)</span>
<span class="fc" id="L108">                .scheme(scheme)</span>
<span class="fc" id="L109">                .build();</span>

<span class="fc" id="L111">        Response response = restClient.target(uri)</span>
<span class="fc" id="L112">                .path(&quot;config&quot;)</span>
<span class="fc" id="L113">                .path(&quot;peers&quot;)</span>
<span class="fc" id="L114">                .request(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L115">                .accept(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L116">                .put(Entity.entity(peer, MediaType.APPLICATION_JSON));</span>

<span class="fc bfc" id="L118" title="All 2 branches covered.">        if (response.getStatus() == Response.Status.CREATED.getStatusCode()) {</span>

<span class="fc" id="L120">            sys().out().printf(&quot;Peer %s added.&quot;, response.getLocation());</span>
<span class="fc" id="L121">            sys().out().println();</span>

<span class="fc" id="L123">            return new CliResult(0, true, null);</span>
        }

<span class="fc" id="L126">        sys().err().println(&quot;Unable to create peer&quot;);</span>

<span class="fc" id="L128">        return new CliResult(1, true, null);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>