<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>KeyUpdateParser.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">config-cli</a> &gt; <a href="index.source.html" class="el_package">com.quorum.tessera.config.cli.parsers</a> &gt; <span class="el_source">KeyUpdateParser.java</span></div><h1>KeyUpdateParser.java</h1><pre class="source lang-java linenums">package com.quorum.tessera.config.cli.parsers;

import com.quorum.tessera.config.ArgonOptions;
import com.quorum.tessera.config.KeyDataConfig;
import com.quorum.tessera.config.PrivateKeyData;
import com.quorum.tessera.config.PrivateKeyType;
import com.quorum.tessera.config.keys.KeyEncryptor;
import com.quorum.tessera.config.util.JaxbUtil;
import com.quorum.tessera.config.util.PasswordReader;
import com.quorum.tessera.encryption.PrivateKey;
import com.quorum.tessera.io.SystemAdapter;
import org.apache.commons.cli.CommandLine;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.List;
import java.util.Objects;
import java.util.Optional;

import static java.nio.charset.StandardCharsets.UTF_8;
import java.util.Base64;
import static java.util.Collections.emptyList;
import static java.util.Collections.singletonList;

public class KeyUpdateParser implements Parser&lt;Optional&gt; {

<span class="fc" id="L31">    private static final Logger LOGGER = LoggerFactory.getLogger(KeyUpdateParser.class);</span>

    private final KeyEncryptor keyEncryptor;

    private final PasswordReader passwordReader;

<span class="fc" id="L37">    public KeyUpdateParser(final KeyEncryptor keyEncryptor, final PasswordReader passwordReader) {</span>
<span class="fc" id="L38">        this.keyEncryptor = Objects.requireNonNull(keyEncryptor);</span>
<span class="fc" id="L39">        this.passwordReader = Objects.requireNonNull(passwordReader);</span>
<span class="fc" id="L40">    }</span>

    @Override
    public Optional parse(final CommandLine commandLine) throws IOException {
<span class="fc bfc" id="L44" title="All 2 branches covered.">        if (commandLine.hasOption(&quot;updatepassword&quot;)) {</span>
<span class="fc" id="L45">            final ArgonOptions argonOptions = argonOptions(commandLine);</span>
<span class="fc" id="L46">            final List&lt;String&gt; passwords = passwords(commandLine);</span>
<span class="fc" id="L47">            final Path keypath = privateKeyPath(commandLine);</span>

<span class="fc" id="L49">            final KeyDataConfig keyDataConfig = JaxbUtil.unmarshal(Files.newInputStream(keypath), KeyDataConfig.class);</span>
<span class="fc" id="L50">            final PrivateKey privateKey = this.getExistingKey(keyDataConfig, passwords);</span>

<span class="fc" id="L52">            final String newPassword = passwordReader.requestUserPassword();</span>

            final KeyDataConfig updatedKey;
<span class="fc bfc" id="L55" title="All 2 branches covered.">            if(newPassword.isEmpty()) {</span>
<span class="fc" id="L56">                final PrivateKeyData privateKeyData = new PrivateKeyData(privateKey.encodeToBase64(), null, null, null, null);</span>
<span class="fc" id="L57">                updatedKey = new KeyDataConfig(privateKeyData, PrivateKeyType.UNLOCKED);</span>
<span class="fc" id="L58">            } else {</span>
<span class="fc" id="L59">                final PrivateKeyData privateKeyData = keyEncryptor.encryptPrivateKey(privateKey, newPassword, argonOptions);</span>
<span class="fc" id="L60">                updatedKey = new KeyDataConfig(privateKeyData, PrivateKeyType.LOCKED);</span>
            }

            //write the key to file
<span class="fc" id="L64">            Files.write(keypath, JaxbUtil.marshalToString(updatedKey).getBytes(UTF_8));</span>
<span class="fc" id="L65">            SystemAdapter.INSTANCE.out().println(&quot;Private key at &quot; + keypath.toString() + &quot; updated.&quot;);</span>
        }

<span class="fc" id="L68">        return Optional.empty();</span>
    }

    PrivateKey getExistingKey(final KeyDataConfig kdc, final List&lt;String&gt; passwords) {

<span class="fc bfc" id="L73" title="All 2 branches covered.">        if (kdc.getType() == PrivateKeyType.UNLOCKED) {</span>
<span class="fc" id="L74">            byte[] privateKeyData = Base64.getDecoder().decode(kdc.getValue().getBytes(UTF_8));</span>
<span class="fc" id="L75">            return PrivateKey.from(privateKeyData);</span>
        } else {

<span class="fc bfc" id="L78" title="All 2 branches covered.">            for (final String pass : passwords) {</span>
                try {
<span class="fc" id="L80">                    return PrivateKey.from(keyEncryptor.decryptPrivateKey(kdc.getPrivateKeyData(), pass).getKeyBytes());</span>
<span class="fc" id="L81">                } catch (final Exception e) {</span>
<span class="fc" id="L82">                    LOGGER.debug(&quot;Password failed to decrypt. Trying next if available.&quot;);</span>
                }
<span class="fc" id="L84">            }</span>

<span class="fc" id="L86">            throw new IllegalArgumentException(&quot;Locked key but no valid password given&quot;);</span>
        }
    }

    static Path privateKeyPath(final CommandLine commandLine) {
<span class="fc" id="L91">        final String privateKeyPath = commandLine.getOptionValue(&quot;keys.keyData.privateKeyPath&quot;);</span>

<span class="fc bfc" id="L93" title="All 2 branches covered.">        if (privateKeyPath == null) {</span>
<span class="fc" id="L94">            throw new IllegalArgumentException(&quot;Private key path cannot be null when updating key password&quot;);</span>
        }

<span class="fc" id="L97">        final Path keypath = Paths.get(privateKeyPath);</span>
<span class="fc bfc" id="L98" title="All 2 branches covered.">        if (Files.notExists(keypath)) {</span>
<span class="fc" id="L99">            throw new IllegalArgumentException(&quot;Private key path must exist when updating key password&quot;);</span>
        }

<span class="fc" id="L102">        return keypath;</span>
    }

    static List&lt;String&gt; passwords(final CommandLine commandLine) throws IOException {
<span class="fc" id="L106">        final String password = commandLine.getOptionValue(&quot;keys.passwords&quot;);</span>
<span class="fc" id="L107">        final String passwordFile = commandLine.getOptionValue(&quot;keys.passwordFile&quot;);</span>

<span class="fc bfc" id="L109" title="All 2 branches covered.">        if (password != null) {</span>
<span class="fc" id="L110">            return singletonList(password);</span>
<span class="fc bfc" id="L111" title="All 2 branches covered.">        } else if (passwordFile != null) {</span>
<span class="fc" id="L112">            return Files.readAllLines(Paths.get(passwordFile));</span>
        } else {
<span class="fc" id="L114">            return emptyList();</span>
        }

    }

    static ArgonOptions argonOptions(final CommandLine commandLine) {
<span class="fc" id="L120">        final String algorithm = commandLine.getOptionValue(&quot;keys.keyData.config.data.aopts.algorithm&quot;, &quot;i&quot;);</span>
<span class="fc" id="L121">        final String iterations = commandLine.getOptionValue(&quot;keys.keyData.config.data.aopts.iterations&quot;, &quot;10&quot;);</span>
<span class="fc" id="L122">        final String memory = commandLine.getOptionValue(&quot;keys.keyData.config.data.aopts.memory&quot;, &quot;1048576&quot;);</span>
<span class="fc" id="L123">        final String parallelism = commandLine.getOptionValue(&quot;keys.keyData.config.data.aopts.parallelism&quot;, &quot;4&quot;);</span>

<span class="fc" id="L125">        return new ArgonOptions(</span>
<span class="fc" id="L126">            algorithm, Integer.valueOf(iterations), Integer.valueOf(memory), Integer.valueOf(parallelism)</span>
        );
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>