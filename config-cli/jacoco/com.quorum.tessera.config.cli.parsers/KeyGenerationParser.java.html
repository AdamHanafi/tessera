<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>KeyGenerationParser.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">config-cli</a> &gt; <a href="index.source.html" class="el_package">com.quorum.tessera.config.cli.parsers</a> &gt; <span class="el_source">KeyGenerationParser.java</span></div><h1>KeyGenerationParser.java</h1><pre class="source lang-java linenums">package com.quorum.tessera.config.cli.parsers;

import com.quorum.tessera.config.*;
import com.quorum.tessera.config.cli.CliException;
import com.quorum.tessera.config.keypairs.ConfigKeyPair;
import com.quorum.tessera.config.util.JaxbUtil;
import com.quorum.tessera.key.generation.KeyGenerator;
import com.quorum.tessera.key.generation.KeyGeneratorFactory;
import com.quorum.tessera.key.generation.KeyVaultOptions;
import org.apache.commons.cli.CommandLine;

import javax.validation.ConstraintViolation;
import javax.validation.ConstraintViolationException;
import javax.validation.Validation;
import javax.validation.Validator;
import java.io.IOException;
import java.io.InputStream;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.Set;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import static java.util.Collections.singletonList;

<span class="fc" id="L30">public class KeyGenerationParser implements Parser&lt;List&lt;ConfigKeyPair&gt;&gt; {</span>

<span class="fc" id="L32">    private final KeyGeneratorFactory factory = KeyGeneratorFactory.newFactory();</span>

<span class="fc" id="L34">    private final Validator validator = Validation.byDefaultProvider()</span>
<span class="fc" id="L35">        .configure()</span>
<span class="fc" id="L36">        .ignoreXmlConfiguration()</span>
<span class="fc" id="L37">        .buildValidatorFactory()</span>
<span class="fc" id="L38">        .getValidator();</span>

    public List&lt;ConfigKeyPair&gt; parse(final CommandLine commandLine) throws IOException {

<span class="fc" id="L42">        final ArgonOptions argonOptions = this.argonOptions(commandLine).orElse(null);</span>
<span class="fc" id="L43">        final KeyVaultOptions keyVaultOptions = this.keyVaultOptions(commandLine).orElse(null);</span>
<span class="fc" id="L44">        final KeyVaultConfig keyVaultConfig = this.keyVaultConfig(commandLine).orElse(null);</span>

<span class="fc" id="L46">        final KeyGenerator generator = factory.create(keyVaultConfig);</span>

<span class="fc bfc" id="L48" title="All 2 branches covered.">        if (commandLine.hasOption(&quot;keygen&quot;)) {</span>
<span class="fc" id="L49">            return this.filenames(commandLine)</span>
<span class="fc" id="L50">                .stream()</span>
<span class="fc" id="L51">                .map(name -&gt; generator.generate(name, argonOptions, keyVaultOptions))</span>
<span class="fc" id="L52">                .collect(Collectors.toList());</span>
        }

<span class="fc" id="L55">        return new ArrayList&lt;&gt;();</span>
    }

    private Optional&lt;ArgonOptions&gt; argonOptions(final CommandLine commandLine) throws IOException {

<span class="fc bfc" id="L60" title="All 2 branches covered.">        if (commandLine.hasOption(&quot;keygenconfig&quot;)) {</span>
<span class="fc" id="L61">            final String pathName = commandLine.getOptionValue(&quot;keygenconfig&quot;);</span>
<span class="fc" id="L62">            final InputStream configStream = Files.newInputStream(Paths.get(pathName));</span>

<span class="fc" id="L64">            final ArgonOptions argonOptions = JaxbUtil.unmarshal(configStream, ArgonOptions.class);</span>
<span class="fc" id="L65">            return Optional.of(argonOptions);</span>
        }

<span class="fc" id="L68">        return Optional.empty();</span>
    }

    private Optional&lt;KeyVaultOptions&gt; keyVaultOptions(final CommandLine commandLine) {
<span class="fc" id="L72">        Optional&lt;String&gt; secretEngineName = Optional.ofNullable(commandLine.getOptionValue(&quot;keygenvaultsecretengine&quot;));</span>

<span class="fc" id="L74">        return secretEngineName.map(KeyVaultOptions::new);</span>
    }

    private List&lt;String&gt; filenames(final CommandLine commandLine) {

<span class="fc bfc" id="L79" title="All 2 branches covered.">        if (commandLine.hasOption(&quot;filename&quot;)) {</span>

<span class="fc" id="L81">            final String keyNames = commandLine.getOptionValue(&quot;filename&quot;);</span>
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">            if (keyNames != null) {</span>
<span class="fc" id="L83">                return Stream.of(keyNames.split(&quot;,&quot;)).collect(Collectors.toList());</span>
            }

        }

<span class="fc" id="L88">        return singletonList(&quot;&quot;);</span>

    }

    private Optional&lt;KeyVaultConfig&gt; keyVaultConfig(CommandLine commandLine) {
<span class="fc bfc" id="L93" title="All 4 branches covered.">        if(!commandLine.hasOption(&quot;keygenvaulttype&quot;) &amp;&amp; !commandLine.hasOption(&quot;keygenvaulturl&quot;)) {</span>
<span class="fc" id="L94">            return Optional.empty();</span>
        }

<span class="fc" id="L97">        final String t = commandLine.getOptionValue(&quot;keygenvaulttype&quot;);</span>

        KeyVaultType keyVaultType;
        try {
<span class="fc" id="L101">            keyVaultType = KeyVaultType.valueOf(</span>
<span class="fc" id="L102">                t.trim()</span>
<span class="fc" id="L103">                 .toUpperCase()</span>
            );
<span class="fc" id="L105">        } catch(IllegalArgumentException | NullPointerException e) {</span>
<span class="fc" id="L106">            throw new CliException(&quot;Key vault type either not provided or not recognised&quot;);</span>
<span class="fc" id="L107">        }</span>

<span class="fc" id="L109">        String keyVaultUrl = commandLine.getOptionValue(&quot;keygenvaulturl&quot;);</span>

        KeyVaultConfig keyVaultConfig;

<span class="fc bfc" id="L113" title="All 2 branches covered.">        if(keyVaultType.equals(KeyVaultType.AZURE)) {</span>
<span class="fc" id="L114">            keyVaultConfig = new AzureKeyVaultConfig(keyVaultUrl);</span>

<span class="fc" id="L116">            Set&lt;ConstraintViolation&lt;AzureKeyVaultConfig&gt;&gt; violations = validator.validate((AzureKeyVaultConfig)keyVaultConfig);</span>

<span class="fc bfc" id="L118" title="All 2 branches covered.">            if(!violations.isEmpty()) {</span>
<span class="fc" id="L119">                throw new ConstraintViolationException(violations);</span>
            }
<span class="fc" id="L121">        } else {</span>
<span class="fc bfc" id="L122" title="All 2 branches covered.">            if(!commandLine.hasOption(&quot;filename&quot;)) {</span>
<span class="fc" id="L123">                throw new CliException(&quot;At least one -filename must be provided when saving generated keys in a Hashicorp Vault&quot;);</span>
            }

<span class="fc" id="L126">            String approlePath = commandLine.getOptionValue(&quot;keygenvaultapprole&quot;);</span>

<span class="fc" id="L128">            Optional&lt;Path&gt; tlsKeyStorePath = Optional.ofNullable(commandLine.getOptionValue(&quot;keygenvaultkeystore&quot;))</span>
<span class="fc" id="L129">                                                     .map(Paths::get);</span>

<span class="fc" id="L131">            Optional&lt;Path&gt; tlsTrustStorePath = Optional.ofNullable(commandLine.getOptionValue(&quot;keygenvaulttruststore&quot;))</span>
<span class="fc" id="L132">                                                       .map(Paths::get);</span>

<span class="fc" id="L134">            keyVaultConfig = new HashicorpKeyVaultConfig(</span>
                keyVaultUrl,
                approlePath,
<span class="fc" id="L137">                tlsKeyStorePath.orElse(null),</span>
<span class="fc" id="L138">                tlsTrustStorePath.orElse(null)</span>
            );

<span class="fc" id="L141">            Set&lt;ConstraintViolation&lt;HashicorpKeyVaultConfig&gt;&gt; violations = validator.validate((HashicorpKeyVaultConfig)keyVaultConfig);</span>

<span class="fc bfc" id="L143" title="All 2 branches covered.">            if(!violations.isEmpty()) {</span>
<span class="fc" id="L144">                throw new ConstraintViolationException(violations);</span>
            }
        }

<span class="fc" id="L148">        return Optional.of(keyVaultConfig);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>